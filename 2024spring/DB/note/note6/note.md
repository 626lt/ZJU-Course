# Entity-Relationship Model 实体关系模型

## 设计数据库模式时

+ 冗余：数据冗余是指在数据库中存储相同的数据，这样会导致数据不一致，浪费存储空间，增加了数据的维护成本。
+ 不完整：数据不完整是指数据库中的数据不完整

## E-R 图

+ 数据库可以建模为：
  + 实体的集合，entities set
  + 实体之间的关系， relationship
+ 实体是存在且可与其他对象区分开来的对象。
  + 示例：特定人物、公司、事件、工厂
+ 实体具有属性
  + 示例：用户有姓名和地址
+ 实体集是一组共享相同属性的相同类型的实体。
  + 示例：所有人员、公司、树木、假期的集合

### 实体集

![alt text](image-1.png)

在E-R图中，实体集可以按图形方式表示，如下所示：
![alt text](image-2.png)
+ 矩形表示实体集。
+ 实体矩形内列出的属性
+ 下划线表示主键属性

### 关系集 relationship set

![alt text](image-3.png)

+ 关系是多个实体之间的关联
+ 关系集是 $n\geq2$ 个实体之间的数学关系，每个实体都取自实体集

在E-R图中，关系集可以按图形方式表示，如下所示：
![alt text](image-4.png)
+ 使用棱形框表示关系集

#### 具有属性的关系集

![alt text](image-5.png)

An attribute can also be property of a relationship set.
属性也可能是关系集的性质

在E-R图中，具有属性的关系集，其属性是用虚线连接到方框中的
![alt text](image-6.png)

### 角色 roles

关系的实体集不一定非要是两个不同的，同一个实体集内也可以存在关系，这时候就要引入roles即角色的概念。
实体集的每次出现都会在关系中扮演一个“角色”
标签“course_id”和“prereq_id”称为角色。

![alt text](image-8.png)

### degree of a relationship set 一个关系集的度

+ binary relationship（二元联系）
涉及两个实体集（或二级）。
数据库系统中的大多数关系集都是二元的。
+ 在某些情况下，转化为非二元关系更方便，比如三元关系如下：

![alt text](image-9.png)

### Attributes 属性

+ 一个实体是由一系列属性的集合来表示的即实体集的所有成员所拥有的描述性属性。
+ 域 – 每个属性的允许值集 domain
+ 属性类型：
  + simple （简单） 和 composite （复合） 属性。
  + single-valued（单值）和 multivalued（多值）属性
    + 示例：多值属性：phone_numbers
  + 派生（派生）属性
    + 可以从其他属性计算
    + 示例：年龄，给定date_of_birth

多值属性的例子

![alt text](image-10.png)
在E-R图中表示复杂属性：

![alt text](image-11.png)

### Mapping cardinality Constraints 映射基数约束

+ 表示可以通过关系集将另一个实体关联到的实体数。
+ 在描述二元关系集时最有用。
+ 对于二元关系集，映射基数必须是以下类型之一：
  + 一对一
  + 一对多
  + 多对一
  + 多对多

![alt text](image-12.png)
![alt text](image-13.png)
在E-R图中表示映射基数约束：

用箭头表示对一，用线表示对多
例子：教师与学生之间的一对一关系：
+ 一个学生通过关系指导最多与一名教师相关联
+ 教师通过关系指导最多与一名学生相关联

![alt text](image-14.png)

例子：教师与学生之间的一对多关系：
+ 教师通过指导与多个（包括 0 个）学生相关联
+ 一个学生通过指导最多与一名教师相关联，

![alt text](image-16.png)

例子：教师和学生之间的多对一关系中，
+ 教师通过指导最多与一名学生相关联，
+ 并且学生通过指导与多个（包括 0 个）教师相关联

![alt text](image-17.png)

例子：多对多
+ 教师通过顾问与多个（可能是 0）学生相关联
+ 一个学生通过顾问与几个（可能是 0 个）教师相关联

![alt text](image-18.png)

### 全部参与与部分参与 Total and Partial Participation

全部参与（用双线表示）：实体集中的每个实体都参与关系集中的至少一个关系
部分参与：某些实体可能不参与关系集中的任何关系
![alt text](image-19.png)
在这个例子中，每个学生都要有指导老师，但是每个指导老师不一定要指导学生

### 用于表示更复杂约束的表示

一条线可能具有关联的最小基数和最大基数，用l..h表示，其中 l 是最小基数，h 是最大基数

+ l=1 意味着完全参与
+ h=1 表示实体最多参与一个关系
+ h=* 意味着没有限制

![alt text](image-20.png)

老师可以指导0个或者更多的学生，学生必须有一个老师，而且至多只能有一个老师

### 三元关系的基数约束

+ 我们最多允许三元（或更高程度）关系中的一个箭头来指示基数约束
+ 例如，从proj_guide到教师的箭头表示每个学生最多有一个项目指南
+ 为避免混淆，我们outlaw（禁止）多个箭头。

![alt text](image-21.png)

### 主键

主键提供了一种指定如何区分实体和关系的方法。 我们将考虑：
+ 实体集
+ 关系集
+ 弱实体集

#### 实体集

+ 根据定义，各个实体是不同的。
+ 从数据库的角度来看，它们之间的差异必须用它们的属性来表示。
+ 实体的属性值的值必须能够唯一标识该实体。
  + 一个实体集中不允许两个实体在所有属性中具有完全相同的值。
+ **实体的键是一组足以将实体彼此区分开来的属性**

#### 关系集

为了区分关系集的各种关系，我们使用关系集中实体的各个主键。
即关系集的主键是其包含的各个实体的主键的并集
如果关系集有属性，那么关系集的主键也有同样的属性
![alt text](image-22.png)

### 弱实体集（Weak Entity Sets）

+ 没有主键的实体集被称为弱实体集
+ 弱实体集的存在取决于标识性实体集（标识性实体集）的存在
  + 它必须通过从标识到弱实体集的总的一对多关系集与标识实体集相关联
  + E-R图中使用双菱形描绘识别关系（标识性联系）
+ 弱实体集的鉴别器（分辨符或部分键）是一组属性，当弱实体集所依赖的标识实体已知时，用于区分它们的所有实体。
+ 弱实体集的主键由弱实体集存在所依赖的强实体集的主键加上弱实体集的鉴别器组成。

在E-R图中表示弱实体集：
我们用虚线下划线在弱实体集的判别器。
我们将弱实体的识别关系放在双菱形中。
![alt text](image-23.png)

注意：强实体集的主键不会显式存储在弱实体集中，因为它是隐式的。
如果显式存储course_id，则 section 可以成为一个强实体，但 section 和 course 之间的关系将被 course 和 section 共有的属性 course_id 定义的隐式关系复制

### 冗余属性

+ 假设我们有实体集：
  + student, with attributes: ID, name, tot_cred, dept_name
  + department, with attributes: dept_name, building, budget
+ 我们使用关系集 stud_dept 对每个学生都有一个关联部门的事实进行建模
+ 下面的 student 中的属性dept_name复制了关系中存在的信息，因此是多余的
+ 并且需要删除。

![alt text](image-24.png)

### E-R图的例子
![alt text](image.png)

+ 方框表示实体，同类型实体的集合，里面是描述实体的属性
+ 棱形框表示关系，框内名字是关系的名字
+ 箭头代表最多一个，是一对一关系；没有箭头代表多个，是一对多关系或者多对多的关系
+ 下划线代表主键，虚线下划线代表
+ 虚线代表弱实体，不能独立存在，必须依赖于强实体
+ 棱形双框代表弱实体依赖于强实体的关系
+ 单线代表部分参与，双线代表一定参与，即一定有。

## 简化为关系模式

+ 实体集和关系集可以统一表示为表示数据库内容的关系模式。
+ 符合 E-R 图的数据库可以由模式集合表示。
+ 对于每个实体集和关系集，都有一个唯一的关系模式，该关系模式分配了相应实体集或关系集的名称。
+ 每个架构都有多个列（通常对应于属性），这些列具有唯一的名称。

### 用简单属性表示实体集

+ 强实体集简化为具有相同属性的关系模式
  + course(course_id, title, credits)
+ 弱实体集将变成一个表，其中包含标识强实体集的主键的列
  + 表的主键是弱实体集的鉴别器和标识强实体集的主键的并集
  + section ( course_id, sec_id, semester, year )
![alt text](image-25.png)

### 表示关系集

多对多关系集表示为一个关系模式，其中包含两个参与实体集的主键的属性，以及关系集的任何描述性属性。

![alt text](image-26.png)

### 关系模式的冗余

多对一和一对多关系集在多方上合计，可以通过向“多”方添加一个额外的属性来表示，其中包含“一”方的主键
![alt text](image-27.png)
将属性dept_name 添加到 instructor 实体集中来替代 新建关系集 instructor_dept

对于一对一的关系集，可以选择任何一方作为“多”方
也就是说，可以将额外的属性添加到与两个实体集对应的任一表中
如果参与在“许多”端是部分的，则在关系模式中用与“许多”端对应的额外属性替换关系模式可能会导致空值
与将弱实体集链接到其标识强实体集的关系集对应的架构是多余的。
示例：部分架构已包含将显示在sec_course架构中的属性

### 复合属性和多值属性

#### 复合属性
+ 通过为每个组件属性创建单独的属性，可以展平复合属性
+ 示例：给定具有复合属性名称的实体集——讲师具有name属性，name具有两个attributes，first_name和last_name。那么实体集对应的关系模式具有两个属性name_first_name和name_last_name，就直接拆分开就可以了
  + 如果没有歧义，则省略前缀
+ 忽略多值属性，则有instructor(ID, 
          first_name, middle_initial,  last_name,      
         street_number, street_name,  apt_number, 
         city, state, zip_code,    date_of_birth, age )


<p align="center">
  <img src="image-28.png" alt="alt text" width="30%">
</p>

#### 多值属性

对于实体E的多值属性M，使用单独的关系模式EM表示
关系模式 EM 具有与 E 的主键对应的属性和与多值属性 M 对应的属性
示例：讲师的多值属性phone_number由架构表示：
inst_phone= ( ID, phone_number) 
多值属性的每个值都映射到架构 EM 上关系的单独元组
例如，主键为 22222、电话号码为 456-7890 和 123-4567 的教师实体映射到两个元组：
    (22222, 456-7890) 
    (22222, 123-4567) 

特殊情况：实体time_slot除了主键属性外只有一个属性，并且该属性是多值属性
time_slot(time_slot_id)
time_slot_detail(time_slot_id, day, start_time, end_time)
优化：不创建实体对应的关系，只创建多值属性对应的关系；就是都堆在一起
time_slot（time_slot_id、day、start_time、end_time）
Caveat（警告）: time_slot attribute of section (from sec_time_slot) cannot be a foreign key due to this optimization

![alt text](image-29.png)

E-R图绘制实战
铁路12306:

1. 实体
   1.  车站
   2.  列车车次
   3.  乘客
   4.  座位
   5.  列车时刻表
2.  关系
   1.  乘客购票
   2.  车次与时刻表
   3.  车次与车票
   4.  车次与列车
   5.  车次与车站
   6.  车站与城市